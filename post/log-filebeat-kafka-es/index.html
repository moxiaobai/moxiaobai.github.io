<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<meta name="google-adsense-account" content="ca-pub-7448149743811927" />
<meta name="robots" content="index, follow" />
<title>
  本地文本日志通过filebeat写入到ES | 莫小白的技术博客
</title>
<meta
  name="keywords"
  content="Filebeat, Kafka, Elasticsearch, Kibana"
/> <meta name="description" content="需求背景：在Kibana能够方便查询服务端程序记录的日志，考虑到公司技术栈多样性，有java、php、golang、python、lua等等。我们采用的方案是程序写本地日志，然后通过Filebeat
上报到Kafka，最后把kafka数据消费写入到Elasticsearch。"> <meta name="author" content=""> <link rel="canonical" href="https://momobaba.top/post/log-filebeat-kafka-es/">
<link
  crossorigin="anonymous"
  href="/assets/css/stylesheet.79ee8125cfdc8fd93dc42a993d3b57d95789de44fe593f658af8d0fbbeb93148.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>
<script
  defer
  crossorigin="anonymous"
  src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js"
  integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
  onload="hljs.initHighlightingOnLoad();"
></script> <link rel="icon" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E"> <link
rel="icon" type="image/png" sizes="16x16" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E"> <link rel="mask-icon" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E"> <meta name="theme-color" content="#2e2e33"> <meta name="msapplication-TileColor" content="#2e2e33"> <link rel="alternate" hreflang="en" href="https://momobaba.top/post/log-filebeat-kafka-es/" />
<noscript>
  <style>
    #theme-toggle,
    .top-link {
      display: none;
    }
  </style>
  <style>
    @media (prefers-color-scheme: dark) {
      :root {
        --theme: rgb(29, 30, 32);
        --entry: rgb(46, 46, 51);
        --primary: rgb(218, 218, 219);
        --secondary: rgb(155, 156, 157);
        --tertiary: rgb(65, 66, 68);
        --content: rgb(196, 196, 197);
        --hljs-bg: rgb(46, 46, 51);
        --code-bg: rgb(55, 56, 62);
        --border: rgb(51, 51, 51);
      }

      .list {
        background: var(--theme);
      }

      .list:not(.dark)::-webkit-scrollbar-track {
        background: 0 0;
      }

      .list:not(.dark)::-webkit-scrollbar-thumb {
        border-color: var(--theme);
      }
    }
  </style>
</noscript><link
  rel="stylesheet"
  href="https://cdn.staticfile.org/hack-font/3.3.0/web/hack.min.css"
/>

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7083ELYPJY"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7083ELYPJY');
        }
      </script><meta property="og:title" content="本地文本日志通过filebeat写入到ES" />
<meta
  property="og:description"
  content="需求背景：在Kibana能够方便查询服务端程序记录的日志，考虑到公司技术栈多样性，有java、php、golang、python、lua等等。我们采用的方案是程序写本地日志，然后通过Filebeat
上报到Kafka，最后把kafka数据消费写入到Elasticsearch。"
/>
<meta
  property="og:type"
  content="article"
/>
<meta property="og:url" content="https://momobaba.top/post/log-filebeat-kafka-es/" /><meta
  property="og:image"
  content="https://momobaba.top/papermod-cover.png"
/><meta property="article:section" content="post" />
<meta
  property="article:published_time"
  content="2023-01-07T20:41:58&#43;08:00"
/> <meta
  property="article:modified_time"
  content="2023-01-07T20:41:58&#43;08:00"
/><meta
  property="og:site_name"
  content="莫小白的技术博客"
/> 
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://momobaba.top/papermod-cover.png" />

<meta name="twitter:title" content="本地文本日志通过filebeat写入到ES" />
<meta
  name="twitter:description"
  content="需求背景：在Kibana能够方便查询服务端程序记录的日志，考虑到公司技术栈多样性，有java、php、golang、python、lua等等。我们采用的方案是程序写本地日志，然后通过Filebeat
上报到Kafka，最后把kafka数据消费写入到Elasticsearch。"
/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://momobaba.top/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "本地文本日志通过filebeat写入到ES",
      "item": "https://momobaba.top/post/log-filebeat-kafka-es/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "本地文本日志通过filebeat写入到ES",
  "name": "本地文本日志通过filebeat写入到ES",
  "description": "需求背景：在Kibana能够方便查询服务端程序记录的日志，考虑到公司技术栈多样性，有java、php、golang、python、lua等等。我们采用的方案是程序写本地日志，然后通过Filebeat 上报到Kafka，最后把kafka数据消费写入到Elasticsearch。\n",
  "keywords": [
    "Filebeat", "Kafka", "Elasticsearch", "Kibana"
  ],
  "articleBody": "需求背景：在Kibana能够方便查询服务端程序记录的日志，考虑到公司技术栈多样性，有java、php、golang、python、lua等等。我们采用的方案是程序写本地日志，然后通过Filebeat 上报到Kafka，最后把kafka数据消费写入到Elasticsearch。\n流程图 程序写入本地文本日志 php程序示例\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 public static function warning(string $category, string $message, array $context = []) { try { self::makeLogger($category, \"warning\")-\u003ewarning($message, $context); } catch (\\Exception $e) { Notification::dingtalk($e-\u003egetMessage()); } } public static function info(string $category, array $context = []) { try { self::makeLogger($category, \"info\")-\u003einfo(\"-\", $context); } catch (\\Exception $e) { Notification::dingtalk($e-\u003egetMessage()); } } 日志内容\n1 2 2022-12-20 01:37:40 INFO rk api '2000000230897' 192.168.1.3 /order/verify | - | {\"orderId\":\"2000000230897\",\"status\":1} 2022-12-20 01:37:40 INFO rk api 'GPA.3316-8111-3644-22366' 192.168.1.3 /order/verify | - | {\"orderId\":\"GPA.3316-8111-3644-22366\",\"status\":1} filebeat上报到kafka 配置文件：web-pay.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #=========================== Filebeat inputs ============================= filebeat.inputs: - type: log enabled: true paths: - /data/wwwroot/pay/logs/*/* fields: env: beta appname: web module: pay #==================== Elasticsearch template setting ========================== setup.template.enabled: false #----------------------------- Kafka output -------------------------------- output.kafka: enabled: true hosts: [\"192.168.1.5:9092\"] topic: 'web_pay_app_log' max_retries: 3 启动filebeat\n1 ./filebeat -e -c web-pay.yml kafka消费数据到Elasticsearch 写入ES数据格式\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 { \"@timestamp\": \"2023-01-07T13:26:49.552Z\", \"@metadata\": { \"beat\": \"filebeat\", \"type\": \"doc\", \"version\": \"6.4.1\", \"topic\": \"web_pay_app_log\" }, \"offset\": 0, \"message\": \"2022-12-20 01:37:40 INFO rk api 'GPA.3316-8111-3644-22366' 192.168.1.3 /order/verify | - | {\\\"orderId\\\":\\\"GPA.3316-8111-3644-22366\\\",\\\"status\\\":1}\", \"prospector\": { \"type\": \"log\" }, \"input\": { \"type\": \"log\" }, \"fields\": { \"env\": \"beta\", \"appname\": \"web\", \"module\": \"pay\" }, \"beat\": { \"name\": \"OA\", \"hostname\": \"OA\", \"version\": \"6.4.1\" }, \"host\": { \"name\": \"OA\" }, \"source\": \"/data/wwwroot/pay/logs/rk/inapp-2023-01-07.log\" } golang消费kafka数据到ES\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 package main import ( \"context\" \"encoding/json\" \"fmt\" \"log\" \"runtime/debug\" \"strings\" \"time\" es6 \"github.com/elastic/go-elasticsearch/v6\" \"github.com/elastic/go-elasticsearch/v6/esapi\" \"github.com/segmentio/kafka-go\" ) var ( brokers = []string{\"10.0.0.1:9092\", \"10.0.0.2:9092\", \"10.0.0.3:9092\"} topic = \"web_pay_app_log\" es *es6.Client err error ) // Message数据还需要进一步解析，偷懒没有做 type message struct { Host struct { Name string `json:\"name\"` } `json:\"host\"` Fields struct { Env string `json:\"env\"` App string `json:\"app\"` } `json:\"fields\"` Message string `json:\"message\"` } type document struct { Env string App string Host string Message string } func main() { goWithRecover(func() { consumer() }) select {} } func consumer() { r := kafka.NewReader(kafka.ReaderConfig{ Brokers: brokers, GroupID: \"consumer-group-\" + topic, Topic: topic, MinBytes: 10e3, // 10KB MaxBytes: 10e6, // 10MB }) cfg := es6.Config{ Addresses: []string{ \"http://192.168.1.211:9200\", }, } if es, err = es6.NewClient(cfg); err != nil { log.Fatalf(\"Error creating the client: %s\", err) } ctx := context.Background() for { m, err := r.ReadMessage(ctx) if err != nil { break } var ( msg message doc document ) json.Unmarshal(m.Value, \u0026msg) doc.App = msg.Fields.App doc.Env = msg.Fields.Env doc.Host = msg.Host.Name doc.Message = msg.Message body, _ := json.Marshal(doc) writeToEs(string(body)) if err := r.CommitMessages(ctx, m); err != nil { fmt.Println(\"failed to commit messages:\", err) } } if err = r.Close(); err != nil { fmt.Println(\"failed to close reader:\", err) } } func writeToEs(body string) { var index = fmt.Sprintf(\"web-pay-%s\", time.Now().Format(\"20060102\")) goWithRecover(func() { req := esapi.IndexRequest{ Index: index, Body: strings.NewReader(body), Refresh: \"true\", } res, err := req.Do(context.Background(), es) if res != nil { defer res.Body.Close() } if err != nil { log.Println(\"Error getting response:\", err) } }) } func goWithRecover(fn func()) { go runSafe(fn) } func runSafe(fn func()) { defer func() { if p := recover(); p != nil { fmt.Println(\"panic recover\", \"panic\", p, \"stack\", string(debug.Stack())) } }() fn() } Kibana查看数据 ",
  "wordCount" : "677",
  "inLanguage": "en",
  "datePublished": "2023-01-07T20:41:58+08:00",
  "dateModified": "2023-01-07T20:41:58+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://momobaba.top/post/log-filebeat-kafka-es/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "莫小白的技术博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://momobaba.top/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://momobaba.top/" accesskey="h" title="首页 (Alt + H)">首页</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://momobaba.top/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://momobaba.top/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://momobaba.top/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://momobaba.top/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/moxiaobai" title="Github">
                    <span>Github</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://momobaba.top/">Home</a>&nbsp;»&nbsp;<a href="https://momobaba.top/post/">Posts</a></div>
    <h1 class="post-title">
      本地文本日志通过filebeat写入到ES
    </h1>
    <div class="post-meta">&lt;span title=&#39;2023-01-07 20:41:58 &#43;0800 CST&#39;&gt;January 7, 2023&lt;/span&gt;&amp;nbsp;·&amp;nbsp;4 min

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%b5%81%e7%a8%8b%e5%9b%be" aria-label="流程图">流程图</a></li>
                <li>
                    <a href="#%e7%a8%8b%e5%ba%8f%e5%86%99%e5%85%a5%e6%9c%ac%e5%9c%b0%e6%96%87%e6%9c%ac%e6%97%a5%e5%bf%97" aria-label="程序写入本地文本日志">程序写入本地文本日志</a></li>
                <li>
                    <a href="#filebeat%e4%b8%8a%e6%8a%a5%e5%88%b0kafka" aria-label="filebeat上报到kafka">filebeat上报到kafka</a></li>
                <li>
                    <a href="#kafka%e6%b6%88%e8%b4%b9%e6%95%b0%e6%8d%ae%e5%88%b0elasticsearch" aria-label="kafka消费数据到Elasticsearch">kafka消费数据到Elasticsearch</a></li>
                <li>
                    <a href="#kibana%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae" aria-label="Kibana查看数据">Kibana查看数据</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>需求背景：在Kibana能够方便查询服务端程序记录的日志，考虑到公司技术栈多样性，有java、php、golang、python、lua等等。我们采用的方案是程序写本地日志，然后通过Filebeat
上报到Kafka，最后把kafka数据消费写入到Elasticsearch。</p>
<hr>
<h2 id="流程图">流程图<a hidden class="anchor" aria-hidden="true" href="#流程图">#</a></h2>
<p><img loading="lazy" src="/img/filebeat-kafka-es.png" alt="filebeat-kafka-es"  />
</p>
<h2 id="程序写入本地文本日志">程序写入本地文本日志<a hidden class="anchor" aria-hidden="true" href="#程序写入本地文本日志">#</a></h2>
<blockquote>
<p>php程序示例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">warning</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$category</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$message</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$context</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="o">::</span><span class="na">makeLogger</span><span class="p">(</span><span class="nv">$category</span><span class="p">,</span> <span class="s2">&#34;warning&#34;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">warning</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Notification</span><span class="o">::</span><span class="na">dingtalk</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">info</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$category</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$context</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="o">::</span><span class="na">makeLogger</span><span class="p">(</span><span class="nv">$category</span><span class="p">,</span> <span class="s2">&#34;info&#34;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Notification</span><span class="o">::</span><span class="na">dingtalk</span><span class="p">(</span><span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>日志内容</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">2022-12-20 01:37:40 INFO rk api <span class="s1">&#39;2000000230897&#39;</span> 192.168.1.3 /order/verify <span class="p">|</span> - <span class="p">|</span> <span class="o">{</span><span class="s2">&#34;orderId&#34;</span>:<span class="s2">&#34;2000000230897&#34;</span>,<span class="s2">&#34;status&#34;</span>:1<span class="o">}</span>
</span></span><span class="line"><span class="cl">2022-12-20 01:37:40 INFO rk api <span class="s1">&#39;GPA.3316-8111-3644-22366&#39;</span> 192.168.1.3 /order/verify <span class="p">|</span> - <span class="p">|</span> <span class="o">{</span><span class="s2">&#34;orderId&#34;</span>:<span class="s2">&#34;GPA.3316-8111-3644-22366&#34;</span>,<span class="s2">&#34;status&#34;</span>:1<span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="filebeat上报到kafka">filebeat上报到kafka<a hidden class="anchor" aria-hidden="true" href="#filebeat上报到kafka">#</a></h2>
<blockquote>
<p>配置文件：web-pay.yml</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#=========================== Filebeat inputs =============================</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">filebeat.inputs:
</span></span><span class="line"><span class="cl">- type: log
</span></span><span class="line"><span class="cl">  enabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  paths:
</span></span><span class="line"><span class="cl">    - /data/wwwroot/pay/logs/*/*
</span></span><span class="line"><span class="cl">  fields:
</span></span><span class="line"><span class="cl">    env: beta
</span></span><span class="line"><span class="cl">    appname: web
</span></span><span class="line"><span class="cl">    module: pay
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#==================== Elasticsearch template setting ==========================</span>
</span></span><span class="line"><span class="cl">setup.template.enabled: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#----------------------------- Kafka output --------------------------------</span>
</span></span><span class="line"><span class="cl">output.kafka:
</span></span><span class="line"><span class="cl"> enabled: <span class="nb">true</span>
</span></span><span class="line"><span class="cl"> hosts: <span class="o">[</span><span class="s2">&#34;192.168.1.5:9092&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"> topic: <span class="s1">&#39;web_pay_app_log&#39;</span>
</span></span><span class="line"><span class="cl"> max_retries: <span class="m">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>启动filebeat</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./filebeat -e -c web-pay.yml
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="kafka消费数据到elasticsearch">kafka消费数据到Elasticsearch<a hidden class="anchor" aria-hidden="true" href="#kafka消费数据到elasticsearch">#</a></h2>
<blockquote>
<p>写入ES数据格式</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@timestamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-01-07T13:26:49.552Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;@metadata&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;beat&#34;</span><span class="p">:</span> <span class="s2">&#34;filebeat&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;doc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;6.4.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;web_pay_app_log&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;offset&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;2022-12-20 01:37:40 INFO rk api &#39;GPA.3316-8111-3644-22366&#39; 192.168.1.3 /order/verify | - | {\&#34;orderId\&#34;:\&#34;GPA.3316-8111-3644-22366\&#34;,\&#34;status\&#34;:1}&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;prospector&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;input&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;fields&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;env&#34;</span><span class="p">:</span> <span class="s2">&#34;beta&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;appname&#34;</span><span class="p">:</span> <span class="s2">&#34;web&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;module&#34;</span><span class="p">:</span> <span class="s2">&#34;pay&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;beat&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;OA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;hostname&#34;</span><span class="p">:</span> <span class="s2">&#34;OA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;6.4.1&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;OA&#34;</span>
</span></span><span class="line"><span class="cl">   <span class="p">},</span>
</span></span><span class="line"><span class="cl">   <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="s2">&#34;/data/wwwroot/pay/logs/rk/inapp-2023-01-07.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>golang消费kafka数据到ES</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;context&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;encoding/json&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;runtime/debug&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;strings&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">es6</span> <span class="s">&#34;github.com/elastic/go-elasticsearch/v6&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/elastic/go-elasticsearch/v6/esapi&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/segmentio/kafka-go&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">brokers</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;10.0.0.1:9092&#34;</span><span class="p">,</span> <span class="s">&#34;10.0.0.2:9092&#34;</span><span class="p">,</span> <span class="s">&#34;10.0.0.3:9092&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">topic</span>   <span class="p">=</span> <span class="s">&#34;web_pay_app_log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">es</span>  <span class="o">*</span><span class="nx">es6</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Message数据还需要进一步解析，偷懒没有做
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">message</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Host</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="s">`json:&#34;host&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Fields</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Env</span> <span class="kt">string</span> <span class="s">`json:&#34;env&#34;`</span>
</span></span><span class="line"><span class="cl">		<span class="nx">App</span> <span class="kt">string</span> <span class="s">`json:&#34;app&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="s">`json:&#34;fields&#34;`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Message</span> <span class="kt">string</span> <span class="s">`json:&#34;message&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">document</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Env</span>     <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">App</span>     <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Host</span>    <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Message</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">goWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">consumer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">select</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">consumer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">kafka</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">kafka</span><span class="p">.</span><span class="nx">ReaderConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Brokers</span><span class="p">:</span>  <span class="nx">brokers</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">GroupID</span><span class="p">:</span>  <span class="s">&#34;consumer-group-&#34;</span> <span class="o">+</span> <span class="nx">topic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Topic</span><span class="p">:</span>    <span class="nx">topic</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">MinBytes</span><span class="p">:</span> <span class="mf">10e3</span><span class="p">,</span> <span class="c1">// 10KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">MaxBytes</span><span class="p">:</span> <span class="mf">10e6</span><span class="p">,</span> <span class="c1">// 10MB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">es6</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Addresses</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;http://192.168.1.211:9200&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">es</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">es6</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error creating the client: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">ReadMessage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">msg</span> <span class="nx">message</span>
</span></span><span class="line"><span class="cl">			<span class="nx">doc</span> <span class="nx">document</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">doc</span><span class="p">.</span><span class="nx">App</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Fields</span><span class="p">.</span><span class="nx">App</span>
</span></span><span class="line"><span class="cl">		<span class="nx">doc</span><span class="p">.</span><span class="nx">Env</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Fields</span><span class="p">.</span><span class="nx">Env</span>
</span></span><span class="line"><span class="cl">		<span class="nx">doc</span><span class="p">.</span><span class="nx">Host</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Host</span><span class="p">.</span><span class="nx">Name</span>
</span></span><span class="line"><span class="cl">		<span class="nx">doc</span><span class="p">.</span><span class="nx">Message</span> <span class="p">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Message</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">writeToEs</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">CommitMessages</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to commit messages:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to close reader:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">writeToEs</span><span class="p">(</span><span class="nx">body</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">index</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;web-pay-%s&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;20060102&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nf">goWithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">req</span> <span class="o">:=</span> <span class="nx">esapi</span><span class="p">.</span><span class="nx">IndexRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Index</span><span class="p">:</span>   <span class="nx">index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Body</span><span class="p">:</span>    <span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">body</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Refresh</span><span class="p">:</span> <span class="s">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">es</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">res</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error getting response:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goWithRecover</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nf">runSafe</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runSafe</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">p</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;panic recover&#34;</span><span class="p">,</span> <span class="s">&#34;panic&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="s">&#34;stack&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">debug</span><span class="p">.</span><span class="nf">Stack</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="kibana查看数据">Kibana查看数据<a hidden class="anchor" aria-hidden="true" href="#kibana查看数据">#</a></h2>
<p><img loading="lazy" src="/img/kibana.png" alt="kibana"  />
</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://momobaba.top/tags/filebeat/">Filebeat</a></li>
      <li><a href="https://momobaba.top/tags/kafka/">Kafka</a></li>
      <li><a href="https://momobaba.top/tags/elasticsearch/">Elasticsearch</a></li>
      <li><a href="https://momobaba.top/tags/kibana/">Kibana</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://momobaba.top/post/gitlab-devops-cicd/">
    <span class="title">« Prev</span>
    <br>
    <span>Gitlab Devops CICD</span>
  </a>
  <a class="next" href="https://momobaba.top/post/go-kafaka/">
    <span class="title">Next »</span>
    <br>
    <span>Go Kafka示例代码</span>
  </a>
</nav>

  </footer>

<script
  src="https://utteranc.es/client.js"
  repo="moxiaobai/moxiaobai.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://momobaba.top/">莫小白的技术博客</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
