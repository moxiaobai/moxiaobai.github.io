<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<meta name="google-adsense-account" content="ca-pub-7448149743811927" />
<meta name="robots" content="index, follow" />
<title>
  Gitlab Devops CICD | 莫小白的技术博客
</title>
<meta
  name="keywords"
  content="Devops, Gitlab"
/> <meta name="description" content="GitLab 是一个强大的开源代码托管平台，它还提供了一套完整的 CI/CD（持续集成/持续交付）工具，称为 GitLab CI/CD。通过 GitLab CI/CD，您可以实现自动化的构建、测试和部署流程，以帮助加快软件交付速度和质量。"> <meta name="author" content=""> <link rel="canonical" href="https://momobaba.top/post/gitlab-devops-cicd/">
<link
  crossorigin="anonymous"
  href="/assets/css/stylesheet.79ee8125cfdc8fd93dc42a993d3b57d95789de44fe593f658af8d0fbbeb93148.css"
  integrity=""
  rel="preload stylesheet"
  as="style"
/>
<script
  defer
  crossorigin="anonymous"
  src="/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js"
  integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
  onload="hljs.initHighlightingOnLoad();"
></script> <link rel="icon" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E"> <link
rel="icon" type="image/png" sizes="16x16" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E"> <link rel="mask-icon" href="https://momobaba.top/%3Clink%20/%20abs%20url%3E"> <meta name="theme-color" content="#2e2e33"> <meta name="msapplication-TileColor" content="#2e2e33"> <link rel="alternate" hreflang="en" href="https://momobaba.top/post/gitlab-devops-cicd/" />
<noscript>
  <style>
    #theme-toggle,
    .top-link {
      display: none;
    }
  </style>
  <style>
    @media (prefers-color-scheme: dark) {
      :root {
        --theme: rgb(29, 30, 32);
        --entry: rgb(46, 46, 51);
        --primary: rgb(218, 218, 219);
        --secondary: rgb(155, 156, 157);
        --tertiary: rgb(65, 66, 68);
        --content: rgb(196, 196, 197);
        --hljs-bg: rgb(46, 46, 51);
        --code-bg: rgb(55, 56, 62);
        --border: rgb(51, 51, 51);
      }

      .list {
        background: var(--theme);
      }

      .list:not(.dark)::-webkit-scrollbar-track {
        background: 0 0;
      }

      .list:not(.dark)::-webkit-scrollbar-thumb {
        border-color: var(--theme);
      }
    }
  </style>
</noscript><link
  rel="stylesheet"
  href="https://cdn.staticfile.org/hack-font/3.3.0/web/hack.min.css"
/>

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7083ELYPJY"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7083ELYPJY');
        }
      </script><meta property="og:title" content="Gitlab Devops CICD" />
<meta
  property="og:description"
  content="GitLab 是一个强大的开源代码托管平台，它还提供了一套完整的 CI/CD（持续集成/持续交付）工具，称为 GitLab CI/CD。通过 GitLab CI/CD，您可以实现自动化的构建、测试和部署流程，以帮助加快软件交付速度和质量。"
/>
<meta
  property="og:type"
  content="article"
/>
<meta property="og:url" content="https://momobaba.top/post/gitlab-devops-cicd/" /><meta
  property="og:image"
  content="https://momobaba.top/papermod-cover.png"
/><meta property="article:section" content="post" />
<meta
  property="article:published_time"
  content="2023-07-13T18:40:32&#43;08:00"
/> <meta
  property="article:modified_time"
  content="2023-07-13T18:40:32&#43;08:00"
/><meta
  property="og:site_name"
  content="莫小白的技术博客"
/> 
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://momobaba.top/papermod-cover.png" />

<meta name="twitter:title" content="Gitlab Devops CICD" />
<meta
  name="twitter:description"
  content="GitLab 是一个强大的开源代码托管平台，它还提供了一套完整的 CI/CD（持续集成/持续交付）工具，称为 GitLab CI/CD。通过 GitLab CI/CD，您可以实现自动化的构建、测试和部署流程，以帮助加快软件交付速度和质量。"
/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://momobaba.top/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Gitlab Devops CICD",
      "item": "https://momobaba.top/post/gitlab-devops-cicd/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gitlab Devops CICD",
  "name": "Gitlab Devops CICD",
  "description": "GitLab 是一个强大的开源代码托管平台，它还提供了一套完整的 CI/CD（持续集成/持续交付）工具，称为 GitLab CI/CD。通过 GitLab CI/CD，您可以实现自动化的构建、测试和部署流程，以帮助加快软件交付速度和质量。\n",
  "keywords": [
    "Devops", "Gitlab"
  ],
  "articleBody": "GitLab 是一个强大的开源代码托管平台，它还提供了一套完整的 CI/CD（持续集成/持续交付）工具，称为 GitLab CI/CD。通过 GitLab CI/CD，您可以实现自动化的构建、测试和部署流程，以帮助加快软件交付速度和质量。\nGitLab CI/CD 的一般工作流程 在 GitLab 仓库中创建 .gitlab-ci.yml 文件：在您的项目根目录中创建一个名为 .gitlab-ci.yml 的文件，该文件用于定义 CI/CD 流程的各个阶段、作业和规则。\n定义流程和作业：在 .gitlab-ci.yml 文件中，您可以定义构建、测试和部署等不同阶段的作业。作业定义了要执行的命令、环境变量、依赖关系等。您可以根据项目需求自定义作业。\n触发 CI/CD 流水线：每当您的代码推送到 GitLab 仓库中，GitLab CI/CD 会自动检测到代码变更并触发相应的流水线。流水线根据 .gitlab-ci.yml 文件中的定义，按顺序执行各个阶段的作业。\n执行作业：在每个阶段中，GitLab CI/CD 会执行定义的作业。这些作业可以是构建项目、运行单元测试、进行静态代码分析、部署到服务器等。\n监视流水线：您可以在 GitLab 的用户界面中查看流水线的状态、作业的执行结果和日志。这有助于您了解流水线的进度和任何错误或失败的作业。\n集成部署和持续交付：借助 GitLab CI/CD，您可以将自动化部署和持续交付流程集成到流水线中。这意味着每次代码变更后，您可以自动构建和部署您的应用程序，从而实现快速的交付和发布。\n服务器安装Gitlab Runner 1 2 3 curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash yum install gitlab-runner Gitlab Runner注册 配置gitlab url 和token(Gitlab菜单：Setttings -\u003e CI/CD -\u003e Runners settings （找到Token）)\n注册命令\n1 2 3 4 5 6 7 8 gitlab-runner register \\ --non-interactive \\ --url \"https://gitlab.xxx.com/\" \\ --registration-token \"FzrGohrfDsKjYTfEfHRX\" \\ --executor \"shell\" \\ --description \"game-version-update\" \\ --tag-list \"go-ci\" \\ --locked=\"false\" \\ .gitlab-ci.yml 文件 代码合并到develop分支，会构建测试包，然后部署到内网测试环境 部署到生产环境，需要新建tag标签，会自动构建正式包，并部署到正式环境 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 before_script: - env |grep CI - export VERSION=`echo ${CI_COMMIT_TAG} | awk -F\"_\" '{print $1}'` - export MESSAGE=`echo $(git tag -l --format='%(contents)' $VERSION)` stages: - lint - build - deploy - test lint: stage: lint tags: - go-ci script: - echo \"开始静态检测...\" - make lint only: - develop - master - tags # 定义 job build: stage: build tags: - go-ci script: - echo \"开始构建程序...\" - make build only: - master - tags test: stage: test tags: - go-ci script: - echo \"开始打包程序上传...\" - make build - make pack-test - make deploy-test only: - develop # 定义 job deploy: stage: deploy tags: - go-ci script: - echo \"开始打包程序上传...\" - make build - make pack - make deploy only: - tags Go Makefile文件 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 GOPATH ?= $(shell go env GOPATH) UPLOAD ?= $(shell which toolPackage) BIN=\"./bin\" SRC=$(shell find . -name \"*.go\") GO := GO111MODULE=on go GOBUILD := $(GO) build BINARY_NAME := web-api CONF :=.golangci.yml BINARY_FILE := ./bin/$(BINARY_NAME) ifeq (, $(shell which golangci-lint)) $(warning \"could not find golangci-lint in $(PATH), run: curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | sh\") endif ifeq (, $(shell which richgo)) $(warning \"could not find richgo in $(PATH), run: go get github.com/kyoh86/richgo\") endif .PHONY: fmt lint test install_deps clean build_beta build zip zip_beta pack default: all fmt: $(info ******************** checking formatting ********************) @test -z $(shell gofmt -l $(SRC)) || (gofmt -d $(SRC); exit 1) lint: $(info ******************** running lint tools ********************) golangci-lint run -c $(CONF) test: $(info ******************** running tests ********************) richgo test -v ./... install_deps: $(info ******************** downloading dependencies ********************) go get -v ./... build: @$(GOBUILD) -o $(BIN)/$(BINARY_NAME) ./cmd/web/ zip: build @rm -rf $(BINARY_NAME).zip @zip -j $(BINARY_NAME).zip bin/$(BINARY_NAME) clean: rm -rf $(BIN) pack: ifneq ($(BINARY_FILE),$(wildcard $(BINARY_FILE))) $(error Please running `make build` first) endif ifeq ($(VERSION),\"\") $(error Please running `git tag` first) else @tar -czf $(BINARY_NAME)-$(VERSION).tar.gz $(BINARY_FILE) endif pack-test: ifneq ($(BINARY_FILE),$(wildcard $(BINARY_FILE))) $(error Please running `make build` first) endif @tar -czf $(BINARY_NAME)-develop.tar.gz $(BINARY_FILE) deploy: ifeq \"$(UPLOAD)\" \"\" $(error Please set the environment variable toolPackage before running `make`) endif ifneq ($(BINARY_NAME)-$(VERSION).tar.gz,$(wildcard $(BINARY_NAME)-$(VERSION).tar.gz)) $(error Please running `make pack` first) endif toolPackage -f ./$(BINARY_NAME)-$(VERSION).tar.gz -p webApi -t app -v $(VERSION) -rmk \"$(MESSAGE)\" deploy-test: toolPackage -f ./$(BINARY_NAME)-develop.tar.gz -p webApi -t app -v $(shell git describe --tags) -rmk \"$(MESSAGE)\" -env test all: lint build pack Pipelines ",
  "wordCount" : "599",
  "inLanguage": "en",
  "datePublished": "2023-07-13T18:40:32+08:00",
  "dateModified": "2023-07-13T18:40:32+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://momobaba.top/post/gitlab-devops-cicd/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "莫小白的技术博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://momobaba.top/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://momobaba.top/" accesskey="h" title="首页 (Alt + H)">首页</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://momobaba.top/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://momobaba.top/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="https://momobaba.top/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="https://momobaba.top/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://github.com/moxiaobai" title="Github">
                    <span>Github</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://momobaba.top/">Home</a>&nbsp;»&nbsp;<a href="https://momobaba.top/post/">Posts</a></div>
    <h1 class="post-title">
      Gitlab Devops CICD
    </h1>
    <div class="post-meta">July 13, 2023&nbsp;·&nbsp;3 min

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#gitlab-cicd-%e7%9a%84%e4%b8%80%e8%88%ac%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" aria-label="GitLab CI/CD 的一般工作流程">GitLab CI/CD 的一般工作流程</a></li>
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%ae%89%e8%a3%85gitlab-runner" aria-label="服务器安装Gitlab Runner">服务器安装Gitlab Runner</a><ul>
                        
                <li>
                    <a href="#gitlab-runner%e6%b3%a8%e5%86%8c" aria-label="Gitlab Runner注册">Gitlab Runner注册</a></li></ul>
                </li>
                <li>
                    <a href="#gitlab-ciyml-%e6%96%87%e4%bb%b6" aria-label=".gitlab-ci.yml 文件">.gitlab-ci.yml 文件</a></li>
                <li>
                    <a href="#go-makefile%e6%96%87%e4%bb%b6" aria-label="Go Makefile文件">Go Makefile文件</a></li>
                <li>
                    <a href="#pipelines" aria-label="Pipelines">Pipelines</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>GitLab 是一个强大的开源代码托管平台，它还提供了一套完整的 CI/CD（持续集成/持续交付）工具，称为 GitLab CI/CD。通过 GitLab CI/CD，您可以实现自动化的构建、测试和部署流程，以帮助加快软件交付速度和质量。</p>
<hr>
<h2 id="gitlab-cicd-的一般工作流程">GitLab CI/CD 的一般工作流程<a hidden class="anchor" aria-hidden="true" href="#gitlab-cicd-的一般工作流程">#</a></h2>
<ol>
<li>
<p>在 GitLab 仓库中创建 .gitlab-ci.yml 文件：在您的项目根目录中创建一个名为 .gitlab-ci.yml 的文件，该文件用于定义 CI/CD 流程的各个阶段、作业和规则。</p>
</li>
<li>
<p>定义流程和作业：在 .gitlab-ci.yml 文件中，您可以定义构建、测试和部署等不同阶段的作业。作业定义了要执行的命令、环境变量、依赖关系等。您可以根据项目需求自定义作业。</p>
</li>
<li>
<p>触发 CI/CD 流水线：每当您的代码推送到 GitLab 仓库中，GitLab CI/CD 会自动检测到代码变更并触发相应的流水线。流水线根据 .gitlab-ci.yml 文件中的定义，按顺序执行各个阶段的作业。</p>
</li>
<li>
<p>执行作业：在每个阶段中，GitLab CI/CD 会执行定义的作业。这些作业可以是构建项目、运行单元测试、进行静态代码分析、部署到服务器等。</p>
</li>
<li>
<p>监视流水线：您可以在 GitLab 的用户界面中查看流水线的状态、作业的执行结果和日志。这有助于您了解流水线的进度和任何错误或失败的作业。</p>
</li>
<li>
<p>集成部署和持续交付：借助 GitLab CI/CD，您可以将自动化部署和持续交付流程集成到流水线中。这意味着每次代码变更后，您可以自动构建和部署您的应用程序，从而实现快速的交付和发布。</p>
</li>
</ol>
<h2 id="服务器安装gitlab-runner">服务器安装Gitlab Runner<a hidden class="anchor" aria-hidden="true" href="#服务器安装gitlab-runner">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh <span class="p">|</span> sudo bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yum install gitlab-runner
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gitlab-runner注册">Gitlab Runner注册<a hidden class="anchor" aria-hidden="true" href="#gitlab-runner注册">#</a></h3>
<blockquote>
<p>配置gitlab url 和token(Gitlab菜单：Setttings -&gt; CI/CD -&gt; Runners settings （找到Token）)</p>
</blockquote>
<p><img loading="lazy" src="/img/gitlab-runner.png" alt="gitlab-runner"  />
</p>
<p><strong>注册命令</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">gitlab-runner register <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --non-interactive <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --url <span class="s2">&#34;https://gitlab.xxx.com/&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --registration-token <span class="s2">&#34;FzrGohrfDsKjYTfEfHRX&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --executor <span class="s2">&#34;shell&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --description <span class="s2">&#34;game-version-update&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --tag-list <span class="s2">&#34;go-ci&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --locked<span class="o">=</span><span class="s2">&#34;false&#34;</span> <span class="se">\
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gitlab-ciyml-文件">.gitlab-ci.yml 文件<a hidden class="anchor" aria-hidden="true" href="#gitlab-ciyml-文件">#</a></h2>
<ol>
<li>代码合并到develop分支，会构建测试包，然后部署到内网测试环境</li>
<li>部署到生产环境，需要新建tag标签，会自动构建正式包，并部署到正式环境</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">before_script:
</span></span><span class="line"><span class="cl">  - env <span class="p">|</span>grep CI
</span></span><span class="line"><span class="cl">  - <span class="nb">export</span> <span class="nv">VERSION</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">CI_COMMIT_TAG</span><span class="si">}</span> <span class="p">|</span> awk -F<span class="s2">&#34;_&#34;</span> <span class="s1">&#39;{print $1}&#39;</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">  - <span class="nb">export</span> <span class="nv">MESSAGE</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">$(</span>git tag -l --format<span class="o">=</span><span class="s1">&#39;%(contents)&#39;</span> <span class="nv">$VERSION</span><span class="k">)</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">stages:
</span></span><span class="line"><span class="cl">  - lint
</span></span><span class="line"><span class="cl">  - build
</span></span><span class="line"><span class="cl">  - deploy
</span></span><span class="line"><span class="cl">  - <span class="nb">test</span>
</span></span><span class="line"><span class="cl">lint:
</span></span><span class="line"><span class="cl">  stage: lint
</span></span><span class="line"><span class="cl">  tags:
</span></span><span class="line"><span class="cl">    - go-ci
</span></span><span class="line"><span class="cl">  script:
</span></span><span class="line"><span class="cl">    - <span class="nb">echo</span> <span class="s2">&#34;开始静态检测...&#34;</span>
</span></span><span class="line"><span class="cl">    - make lint
</span></span><span class="line"><span class="cl">  only:
</span></span><span class="line"><span class="cl">    - develop
</span></span><span class="line"><span class="cl">    - master
</span></span><span class="line"><span class="cl">    - tags
</span></span><span class="line"><span class="cl"><span class="c1"># 定义 job</span>
</span></span><span class="line"><span class="cl">build:
</span></span><span class="line"><span class="cl">  stage: build
</span></span><span class="line"><span class="cl">  tags:
</span></span><span class="line"><span class="cl">    - go-ci
</span></span><span class="line"><span class="cl">  script:
</span></span><span class="line"><span class="cl">    - <span class="nb">echo</span> <span class="s2">&#34;开始构建程序...&#34;</span>
</span></span><span class="line"><span class="cl">    - make build
</span></span><span class="line"><span class="cl">  only:
</span></span><span class="line"><span class="cl">    - master
</span></span><span class="line"><span class="cl">    - tags
</span></span><span class="line"><span class="cl">test:
</span></span><span class="line"><span class="cl">  stage: <span class="nb">test</span>
</span></span><span class="line"><span class="cl">  tags:
</span></span><span class="line"><span class="cl">    - go-ci
</span></span><span class="line"><span class="cl">  script:
</span></span><span class="line"><span class="cl">    - <span class="nb">echo</span> <span class="s2">&#34;开始打包程序上传...&#34;</span>
</span></span><span class="line"><span class="cl">    - make build
</span></span><span class="line"><span class="cl">    - make pack-test
</span></span><span class="line"><span class="cl">    - make deploy-test
</span></span><span class="line"><span class="cl">  only:
</span></span><span class="line"><span class="cl">    - develop
</span></span><span class="line"><span class="cl"><span class="c1"># 定义 job</span>
</span></span><span class="line"><span class="cl">deploy:
</span></span><span class="line"><span class="cl">  stage: deploy
</span></span><span class="line"><span class="cl">  tags:
</span></span><span class="line"><span class="cl">    - go-ci
</span></span><span class="line"><span class="cl">  script:
</span></span><span class="line"><span class="cl">    - <span class="nb">echo</span> <span class="s2">&#34;开始打包程序上传...&#34;</span>
</span></span><span class="line"><span class="cl">    - make build
</span></span><span class="line"><span class="cl">    - make pack
</span></span><span class="line"><span class="cl">    - make deploy
</span></span><span class="line"><span class="cl">  only:
</span></span><span class="line"><span class="cl">    - tags
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="go-makefile文件">Go Makefile文件<a hidden class="anchor" aria-hidden="true" href="#go-makefile文件">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">GOPATH</span> <span class="err">?</span><span class="o">=</span> <span class="o">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">go</span> <span class="n">env</span> <span class="n">GOPATH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">UPLOAD</span> <span class="err">?</span><span class="o">=</span> <span class="o">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">which</span> <span class="n">toolPackage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BIN</span><span class="o">=</span><span class="s2">&#34;./bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SRC</span><span class="o">=$</span><span class="p">(</span><span class="n">shell</span> <span class="n">find</span> <span class="o">.</span> <span class="o">-</span><span class="n">name</span> <span class="s2">&#34;*.go&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">GO</span>        <span class="p">:</span><span class="o">=</span> <span class="n">GO111MODULE</span><span class="o">=</span><span class="n">on</span> <span class="n">go</span>
</span></span><span class="line"><span class="cl"><span class="n">GOBUILD</span>   <span class="p">:</span><span class="o">=</span> <span class="o">$</span><span class="p">(</span><span class="n">GO</span><span class="p">)</span> <span class="n">build</span>
</span></span><span class="line"><span class="cl"><span class="n">BINARY_NAME</span>   <span class="p">:</span><span class="o">=</span> <span class="n">web</span><span class="o">-</span><span class="n">api</span>
</span></span><span class="line"><span class="cl"><span class="n">CONF</span>      <span class="p">:</span><span class="o">=.</span><span class="n">golangci</span><span class="o">.</span><span class="n">yml</span>
</span></span><span class="line"><span class="cl"><span class="n">BINARY_FILE</span> <span class="p">:</span><span class="o">=</span> <span class="o">./</span><span class="n">bin</span><span class="o">/$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ifeq</span> <span class="p">(,</span> <span class="o">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">which</span> <span class="n">golangci</span><span class="o">-</span><span class="n">lint</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="o">$</span><span class="p">(</span><span class="n">warning</span> <span class="s2">&#34;could not find golangci-lint in $(PATH), run: curl -sfL https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | sh&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ifeq</span> <span class="p">(,</span> <span class="o">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">which</span> <span class="n">richgo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="o">$</span><span class="p">(</span><span class="n">warning</span> <span class="s2">&#34;could not find richgo in $(PATH), run: go get github.com/kyoh86/richgo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">.</span><span class="n">PHONY</span><span class="p">:</span> <span class="n">fmt</span> <span class="n">lint</span> <span class="n">test</span> <span class="n">install_deps</span> <span class="n">clean</span> <span class="n">build_beta</span> <span class="n">build</span> <span class="n">zip</span> <span class="n">zip_beta</span> <span class="n">pack</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">default</span><span class="p">:</span> <span class="n">all</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fmt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">info</span> <span class="o">********************</span> <span class="n">checking</span> <span class="n">formatting</span> <span class="o">********************</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="err">@</span><span class="n">test</span> <span class="o">-</span><span class="n">z</span> <span class="o">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">gofmt</span> <span class="o">-</span><span class="n">l</span> <span class="o">$</span><span class="p">(</span><span class="n">SRC</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">gofmt</span> <span class="o">-</span><span class="n">d</span> <span class="o">$</span><span class="p">(</span><span class="n">SRC</span><span class="p">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">lint</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">info</span> <span class="o">********************</span> <span class="n">running</span> <span class="n">lint</span> <span class="n">tools</span> <span class="o">********************</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">golangci</span><span class="o">-</span><span class="n">lint</span> <span class="n">run</span> <span class="o">-</span><span class="n">c</span> <span class="o">$</span><span class="p">(</span><span class="n">CONF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">test</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">info</span> <span class="o">********************</span> <span class="n">running</span> <span class="n">tests</span> <span class="o">********************</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">richgo</span> <span class="n">test</span> <span class="o">-</span><span class="n">v</span> <span class="o">./...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">install_deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">info</span> <span class="o">********************</span> <span class="n">downloading</span> <span class="n">dependencies</span> <span class="o">********************</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">go</span> <span class="n">get</span> <span class="o">-</span><span class="n">v</span> <span class="o">./...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">build</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="err">@</span><span class="o">$</span><span class="p">(</span><span class="n">GOBUILD</span><span class="p">)</span>  <span class="o">-</span><span class="n">o</span> <span class="o">$</span><span class="p">(</span><span class="n">BIN</span><span class="p">)</span><span class="o">/$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span> <span class="o">./</span><span class="n">cmd</span><span class="o">/</span><span class="n">web</span><span class="o">/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">zip</span><span class="p">:</span> <span class="n">build</span>
</span></span><span class="line"><span class="cl">	<span class="err">@</span><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">zip</span>
</span></span><span class="line"><span class="cl">	<span class="err">@</span><span class="n">zip</span> <span class="o">-</span><span class="n">j</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">zip</span> <span class="n">bin</span><span class="o">/$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">clean</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">$</span><span class="p">(</span><span class="n">BIN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pack</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">ifneq</span> <span class="p">(</span><span class="o">$</span><span class="p">(</span><span class="n">BINARY_FILE</span><span class="p">),</span><span class="o">$</span><span class="p">(</span><span class="n">wildcard</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_FILE</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">error</span> <span class="n">Please</span> <span class="n">running</span> <span class="err">`</span><span class="n">make</span> <span class="n">build</span><span class="err">`</span> <span class="n">first</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl"><span class="n">ifeq</span> <span class="p">(</span><span class="o">$</span><span class="p">(</span><span class="n">VERSION</span><span class="p">),</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">error</span> <span class="n">Please</span> <span class="n">running</span> <span class="err">`</span><span class="n">git</span> <span class="n">tag</span><span class="err">`</span> <span class="n">first</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="err">@</span><span class="n">tar</span> <span class="o">-</span><span class="n">czf</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">-$</span><span class="p">(</span><span class="n">VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_FILE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl"><span class="n">pack</span><span class="o">-</span><span class="n">test</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">ifneq</span> <span class="p">(</span><span class="o">$</span><span class="p">(</span><span class="n">BINARY_FILE</span><span class="p">),</span><span class="o">$</span><span class="p">(</span><span class="n">wildcard</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_FILE</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">error</span> <span class="n">Please</span> <span class="n">running</span> <span class="err">`</span><span class="n">make</span> <span class="n">build</span><span class="err">`</span> <span class="n">first</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl">	<span class="err">@</span><span class="n">tar</span> <span class="o">-</span><span class="n">czf</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">-</span><span class="n">develop</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_FILE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">deploy</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">ifeq</span> <span class="s2">&#34;$(UPLOAD)&#34;</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">error</span> <span class="n">Please</span> <span class="n">set</span> <span class="n">the</span> <span class="n">environment</span> <span class="n">variable</span> <span class="n">toolPackage</span> <span class="n">before</span> <span class="n">running</span> <span class="err">`</span><span class="n">make</span><span class="err">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl"><span class="n">ifneq</span> <span class="p">(</span><span class="o">$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">-$</span><span class="p">(</span><span class="n">VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span><span class="p">,</span><span class="o">$</span><span class="p">(</span><span class="n">wildcard</span> <span class="o">$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">-$</span><span class="p">(</span><span class="n">VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">$</span><span class="p">(</span><span class="n">error</span> <span class="n">Please</span> <span class="n">running</span> <span class="err">`</span><span class="n">make</span> <span class="n">pack</span><span class="err">`</span> <span class="n">first</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">endif</span>
</span></span><span class="line"><span class="cl">	<span class="n">toolPackage</span> <span class="o">-</span><span class="n">f</span> <span class="o">./$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">-$</span><span class="p">(</span><span class="n">VERSION</span><span class="p">)</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">p</span> <span class="n">webApi</span> <span class="o">-</span><span class="n">t</span> <span class="n">app</span> <span class="o">-</span><span class="n">v</span> <span class="o">$</span><span class="p">(</span><span class="n">VERSION</span><span class="p">)</span> <span class="o">-</span><span class="n">rmk</span> <span class="s2">&#34;$(MESSAGE)&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">deploy</span><span class="o">-</span><span class="n">test</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">toolPackage</span> <span class="o">-</span><span class="n">f</span> <span class="o">./$</span><span class="p">(</span><span class="n">BINARY_NAME</span><span class="p">)</span><span class="o">-</span><span class="n">develop</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">-</span><span class="n">p</span> <span class="n">webApi</span> <span class="o">-</span><span class="n">t</span> <span class="n">app</span> <span class="o">-</span><span class="n">v</span> <span class="o">$</span><span class="p">(</span><span class="n">shell</span> <span class="n">git</span> <span class="n">describe</span> <span class="o">--</span><span class="n">tags</span><span class="p">)</span> <span class="o">-</span><span class="n">rmk</span> <span class="s2">&#34;$(MESSAGE)&#34;</span> <span class="o">-</span><span class="n">env</span> <span class="n">test</span>
</span></span><span class="line"><span class="cl"><span class="n">all</span><span class="p">:</span> <span class="n">lint</span> <span class="n">build</span> <span class="n">pack</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="pipelines">Pipelines<a hidden class="anchor" aria-hidden="true" href="#pipelines">#</a></h2>
<p><img loading="lazy" src="/img/gitlab-pipeline.png" alt="gitlab-pipeline"  />
</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://momobaba.top/tags/devops/">Devops</a></li>
      <li><a href="https://momobaba.top/tags/gitlab/">Gitlab</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://momobaba.top/post/chaosblade/">
    <span class="title">« Prev</span>
    <br>
    <span>ChaosBlade故障模拟</span>
  </a>
  <a class="next" href="https://momobaba.top/post/log-filebeat-kafka-es/">
    <span class="title">Next »</span>
    <br>
    <span>本地文本日志通过filebeat写入到ES</span>
  </a>
</nav>

  </footer>

<script
  src="https://utteranc.es/client.js"
  repo="moxiaobai/moxiaobai.github.io"
  issue-term="pathname"
  theme="github-light"
  crossorigin="anonymous"
  async
></script>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://momobaba.top/">莫小白的技术博客</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
